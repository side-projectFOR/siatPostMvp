<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.siat.post.domain.post.PostMapper">

  <select id="selectPost" parameterType="Long">
    select 
      post_idx 
      ,board_idx
      ,user_idx
      ,post_author
      ,post_title
      ,post_content
      ,hit
      ,is_secret
      ,post_password
      ,reg_date
      ,update_date
      ,is_delete
    from POST_TBL
    where post_idx = #{id} and is_delete = 0
  </select>
  <select id="selectPostWithPassword" parameterType="com.siat.post.domain.post.dto.PostSecretRequestDto">
    select 
      post_idx 
      ,board_idx
      ,user_idx
      ,post_author
      ,post_title
      ,post_content
      ,hit
      ,is_secret
      ,post_password
      ,reg_date
      ,update_date
      ,is_delete
    from POST_TBL
    where post_idx = #{postIdx} and is_delete = 0 and post_password=#{postPassword}
  </select>
  <select id="selectPosts"
        resultType="com.siat.post.domain.post.dto.PostSimpleInfoResponseDto">
  select
    p.post_idx as postIdx,
    board_idx,
    p.user_idx as userIdx,
    post_author,
    post_title,
    hit,
    is_secret,
    p.reg_date as regDate,
    update_date,
    is_delete,
    COUNT(like_idx) as "likeCnt",
    case 
      when COUNT(like_idx) = 0 then 0
      else MAX(CASE WHEN l.user_idx = #{userIdx} then 1 else 0 end)
    end as likedByUser
  from POST_TBL p
  left join LIKE_TBL l ON p.post_idx = l.post_idx
  where is_delete = 0
  group by p.post_idx, p.board_idx, p.user_idx, p.post_author, p.post_title, p.hit, p.is_secret, p.reg_date, p.update_date, p.is_delete
  order by p.post_idx desc
</select>
  <select id="selectPostsByBoardIdx" parameterType="Integer" resultType="com.siat.post.domain.post.dto.PostSimpleInfoResponseDto">
  select
    p.post_idx as postIdx,
    board_idx,
    p.user_idx as userIdx,
    post_author,
    post_title,
    hit,
    is_secret,
    p.reg_date as regDate,
    update_date,
    is_delete,
    COUNT(like_idx) as likeCnt,
    case 
      when COUNT(like_idx) = 0 then 0
      else MAX(CASE WHEN l.user_idx = #{userIdx} then 1 else 0 end)
    end likedByUser
  from POST_TBL p
  left join LIKE_TBL l ON p.post_idx = l.post_idx
  where is_delete = 0 and board_idx = #{boardIdx}
  group by p.post_idx, p.board_idx, p.user_idx, p.post_author, p.post_title, p.hit, p.is_secret, p.reg_date, p.update_date, p.is_delete
  order by p.post_idx desc 
  </select>
  <insert id="insertPost" parameterType="com.siat.post.domain.post.dto.Post" useGeneratedKeys="true" keyProperty="postIdx" keyColumn="post_idx">
    insert into POST_TBL(
      board_idx
      ,user_idx
      ,post_author
      ,post_title
      ,post_content
      ,hit
      ,is_secret
      ,post_password
      ,reg_date
      )
    values(
      #{boardIdx}
      ,#{userIdx}
      ,#{postAuthor}
      ,#{postTitle}
      ,#{postContent}
      ,#{hit}
      ,#{isSecret}
      ,#{postPassword}
      ,CURRENT_TIMESTAMP
      )
  </insert>
  <update id="updatePost" parameterType="com.siat.post.domain.post.dto.PostUpdateRequestDto">
    update POST_TBL
    <set>
        <if test="boardIdx != null">
        board_idx = #{boardIdx},
        </if>
        <if test="postAuthor != null">
        post_author = #{postAuthor},</if>
        <if test="postTitle != null">post_title = #{postTitle},
        </if>
        <if test="postContent != null">
        post_content = #{postContent},
        </if>
        <if test="isSecret != null">
        is_secret = #{isSecret},
        </if>
        <if test="postPassword != null">
        post_password = #{postPassword},
        </if>
        update_date = CURRENT_TIMESTAMP,
    </set>
    where post_idx = #{postIdx}
  </update>
  <update id="softDeletePost" parameterType="Long">
    update POST_TBL
    set is_delete = 1
    where post_idx = #{postIdx}
  </update>
  <update id="updatePostHit" parameterType="Long">
    update POST_TBL
    set   hit=hit+1
    where post_idx= #{id}
  </update>
  <select id="selectPostIsSecret" parameterType="Long" resultType="int">
      select is_secret 
      from POST_TBL
      where post_idx =#{id}
  </select>
</mapper>